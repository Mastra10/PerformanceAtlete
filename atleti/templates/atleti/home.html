{% extends 'base.html' %}
{% load socialaccount %}
{% load static %}

{% block extra_css %}
<style>
    /* Stile Login Full Screen */
    body, html {
        height: 100%;
        margin: 0;
        font-family: 'Inter', sans-serif;
    }

    .bg-image {
        background-image: url("{% static 'images/barilla4.png' %}");
        height: 100vh;
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
        position: relative;
    }

    .overlay {
        background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7));
        height: 100%;
        width: 100%;
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        padding-left: 5%;
        padding-top: 5%;
    }

    .login-box {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        text-align: center;
        width: 90%;
        max-width: 400px;
    }

    .strava-btn {
        display: inline-block;
        margin-top: 20px;
        transition: transform 0.2s;
    }

    .strava-btn:hover {
        transform: scale(1.05);
    }

    @media (max-width: 768px) {
        .overlay {
            justify-content: center;
            align-items: center;
            padding-left: 0;
            padding-top: 0;
        }
    }
</style>
{% endblock %}

{% block content_unauth %}
<div class="bg-image">
    <div class="overlay">
        <div class="login-box">
            <p class="lead text-muted">Monitora i tuoi progressi, contribuisci al successo del gruppo.</p>
            <hr class="my-4">
            <a href="{% provider_login_url 'strava' %}" class="strava-btn">
                <img src="{% static 'images/btn_strava_connect_with_orange.svg' %}" alt="Connect with Strava" width="237" height="48">
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
    {% if error_message %}
        <div class="alert alert-warning text-center my-5">
            <i class="bi bi-lock-fill display-1 d-block mb-3"></i>
            <h4>{{ error_message }}</h4>
        </div>
    {% else %}
    {% if request.user.is_authenticated and profilo and not profilo.hide_home_notice %}
    <!-- Avviso temporaneo persistente su DB per utente -->
    <div id="temp-home-notice" class="alert alert-info alert-dismissible fade show" role="alert">
        <div class="d-flex justify-content-between align-items-center">
            <div class="me-3">Si prega di fare logout e login per implementazione nuove funzioni</div>
            <div class="d-flex align-items-center">
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" id="tempNoticeDontShow">
                    <label class="form-check-label small" for="tempNoticeDontShow">Non mostrare più</label>
                </div>
                <button type="button" class="btn btn-sm btn-primary ms-2" id="tempNoticeOk">OK</button>
                <button type="button" class="btn-close ms-2" id="tempNoticeClose" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <script>
        (function(){
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            var okBtn = document.getElementById('tempNoticeOk');
            var closeBtn = document.getElementById('tempNoticeClose');
            var el = document.getElementById('temp-home-notice');

            function removeEl() { if(el) el.remove(); }

            if(okBtn) {
                okBtn.addEventListener('click', function(){
                    var cb = document.getElementById('tempNoticeDontShow');
                    var hide = !!(cb && cb.checked);

                    if(hide) {
                        fetch('{% url "hide_home_notice" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({hide: true})
                        }).then(function(resp){
                            if(resp.ok) return resp.json();
                            throw new Error('Network response not ok');
                        }).then(function(data){
                            removeEl();
                        }).catch(function(err){
                            console.error('hide_home_notice error', err);
                            // In caso di errore, rimuoviamo comunque il banner per non infastidire l'utente
                            removeEl();
                        });
                    } else {
                        // Non salviamo preferenza, rimuoviamo solo il banner per questa sessione
                        removeEl();
                    }
                }, {passive:true});
            }

            if(closeBtn) {
                closeBtn.addEventListener('click', function(){ removeEl(); }, {passive:true});
            }
        })();
    </script>
    {% endif %}
    
    {% if request.session.impersonator %}
    <div class="alert alert-danger text-center fw-bold shadow-sm border-danger">
        <i class="bi bi-mask me-2"></i> MODALITÀ IMPERSONIFICAZIONE ATTIVA
        <span class="fw-normal d-block small mt-1">Stai agendo come <u>{{ request.user.username }}</u> (Admin originale: {{ request.session.impersonator }}). <a href="/accounts/logout/" class="text-danger fw-bold">Logout per uscire</a>.</span>
    </div>
    {% endif %}
    
    {% if warning_peso %}
    <div class="alert alert-warning text-center fw-bold">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ warning_peso }}
    </div>
    {% endif %}
    
    <h2 class="fw-bold mb-4">Dashboard Personale</h2>
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card p-4 text-center mb-4">
                <div class="mb-3">
                    {% if profilo.immagine_profilo %}
                        <img src="{{ profilo.immagine_profilo }}" alt="Profilo Strava" class="rounded-circle shadow-sm" style="width: 120px; height: 120px; object-fit: cover; border: 4px solid var(--barilla-blue);">
                    {% else %}
                        <i class="bi bi-person-circle display-1 text-secondary"></i>
                    {% endif %}
                </div>
                <h3 class="fw-bold m-0">
                    {{ profilo.user.first_name }} {{ profilo.user.last_name }}
                    {% if profilo.user.is_staff or request.user.is_staff and profilo.user.id == request.user.id %}
                        <span class="badge bg-dark align-middle ms-2" style="font-size: 0.6em;">ADMIN</span>
                    {% endif %}
                </h3>
                <small class="text-muted">(@{{ profilo.user.username }})</small>
                <div class="badge bg-success my-3">Socio Cral Barilla</div>
                <hr>
                <div class="row text-start g-2">
                    <div class="col-6 border-end text-center">
                        <small class="text-muted d-block">Peso</small>
                        <span class="h5 fw-bold">{{ profilo.peso|default:"--" }} kg</span>
                    </div>
                    <div class="col-6 text-center">
                        <small class="text-muted d-block">FC Max</small>
                        <span class="h5 fw-bold text-danger">{{ profilo.fc_massima_teorica }} bpm</span>
                        <div class="small text-muted" style="font-size: 0.7rem;">
                            {% if profilo.fc_max_manuale %}
                                (Impostata a mano)
                            {% elif profilo.data_fc_max %}
                                {{ profilo.data_fc_max|date:"d/m/Y" }}
                            {% else %}
                                <span class="text-muted" title="Data non disponibile. Sincronizza Strava.">--/--/----</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row text-start g-2">
                    <div class="col-6 border-end text-center">
                        <small class="text-muted d-block">ITRA Index</small>
                        <span class="h5 fw-bold" style="color: #2c3e50;">{{ profilo.indice_itra|default:"--" }}</span>
                        {% if profilo.indice_itra > 0 %}<div class="small fw-bold text-uppercase mt-1" style="color: #2c3e50; font-size: 0.7rem;">{{ livello_itra }}</div>{% endif %}
                    </div>
                    <div class="col-6 text-center">
                        <small class="text-muted d-block">UTMB Index</small>
                        <span class="h5 fw-bold" style="color: #ffc107;">{{ profilo.indice_utmb|default:"--" }}</span>
                        {% if profilo.indice_utmb > 0 %}<div class="small fw-bold text-uppercase mt-1" style="color: #ffc107; font-size: 0.7rem;">{{ livello_utmb }}</div>{% endif %}
                    </div>
                </div>
                <hr>
                <div class="row text-start g-2">
                    <div class="col-6 border-end text-center">
                        <small class="text-muted d-block">Soglia Aerobica</small>
                        <span class="h5 fw-bold text-success">{{ soglia_aerobica }} bpm</span>
                        <div class="small text-muted" style="font-size: 0.7rem;">Stima Fondo (Z2)</div>
                    </div>
                    <div class="col-6 text-center">
                        <small class="text-muted d-block">Soglia Anaerobica</small>
                        <span class="h5 fw-bold text-danger">{{ soglia_anaerobica }} bpm</span>
                        <div class="small text-muted" style="font-size: 0.7rem;">Stima Soglia (Z4)</div>
                    </div>
                </div>
                <hr>
                <div class="row text-start g-2">
                    <div class="col-6 border-end text-center">
                        <small class="text-muted d-block">Passo Medio</small>
                        <span class="h5 fw-bold text-primary">{{ passo_media_recent }}</span>
                        <div class="small text-muted" style="font-size: 0.7rem;">Recente</div>
                    </div>
                    <div class="col-6 text-center">
                        <small class="text-muted d-block">FC Media</small>
                        <span class="h5 fw-bold text-danger">{{ fc_media_recent }} bpm</span>
                        <div class="small text-muted" style="font-size: 0.7rem;">Recente</div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold m-0"><i class="bi bi-sliders me-2"></i>Controlli</h5>
                </div>
                <div class="card-body p-4">
                <a href="{% url 'impostazioni' %}" class="btn btn-outline-dark btn-sm w-100 mb-2"><i class="bi bi-gear-fill me-1"></i> Impostazioni</a>
                <a href="{% url 'strava_sync' %}" 
                   data-bs-toggle="modal" 
                   data-bs-target="#syncModal" 
                   onclick="startSyncRedirect(event)"
                   class="btn btn-outline-secondary btn-sm w-100">
                    <i class="bi bi-arrow-repeat me-1"></i>Sincronizza Strava
                </a>
                <a href="{% url 'ricalcola_statistiche' %}" class="btn btn-outline-primary btn-sm w-100 mt-2">
                    <i class="bi bi-calculator me-1"></i>Ricalcola Dati
                </a>
                <a href="{% url 'export_csv' %}" class="btn btn-outline-success btn-sm w-100 mt-2">
                    <i class="bi bi-download me-1"></i>Scarica Dati CSV
                </a>
                <a href="{% url 'guida_utente' %}" class="btn btn-outline-info btn-sm w-100 mt-2">
                    <i class="bi bi-book-half me-1"></i>Guida & Metriche
                </a>
                <button onclick="generaAnalisiPersonale()" class="btn btn-primary btn-sm w-100 mt-2 shadow-sm">
                    <i class="bi bi-stars me-1"></i>Analisi AI Personalizzata
                </button>
                
                <div class="mt-3 small text-muted text-center border-top pt-2">
                    <div class="mb-1">
                        <i class="bi bi-clock-history me-1"></i>Ultima Sync:<br>
                        <span class="fw-bold text-dark">
                            {% if profilo.data_ultima_sincronizzazione %}{{ profilo.data_ultima_sincronizzazione|date:"d/m H:i" }}{% else %}--{% endif %}
                        </span>
                    </div>
                    <div>
                        <i class="bi bi-calculator me-1"></i>Ultimo Ricalcolo:<br>
                        <span class="fw-bold text-dark">
                            {% if profilo.data_ultimo_ricalcolo_statistiche %}{{ profilo.data_ultimo_ricalcolo_statistiche|date:"d/m H:i" }}{% else %}--{% endif %}
                        </span>
                    </div>
                </div>
                
                {% if request.user.is_staff %}
                <hr>
                <small class="text-muted fw-bold text-uppercase mb-2 d-block">Admin Zone</small>
                <a href="{% url 'scheduler_logs' %}" class="btn btn-outline-info btn-sm w-100">
                    <i class="bi bi-list-task me-1"></i>Log Scheduler
                </a>
                <a href="{% url 'dashboard_coach' %}" class="btn btn-outline-primary btn-sm w-100 mt-2">
                    <i class="bi bi-speedometer2 me-1"></i>Dashboard Coach
                </a>
                {% endif %}

                <!-- DEBUG INFO (Rimuovere in produzione) -->
                <div class="mt-3 p-2 bg-light border small text-muted">
                    User: <strong>{{ request.user.username }}</strong><br>
                    Staff: <strong class="{% if request.user.is_staff %}text-success{% else %}text-danger{% endif %}">{{ request.user.is_staff }}</strong>
                    {% if not request.user.is_staff %}
                    <hr class="my-1">
                    <span class="text-danger fw-bold">NON SEI ADMIN!</span><br>
                    Per abilitare il menu, esegui:<br>
                    <code class="user-select-all" style="background: #eee; padding: 2px;">docker compose exec web python manage.py promote_admin {{ request.user.username }}</code>
                    {% endif %}
                </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="row g-3 mb-4 text-center">
                <!-- Riga 1: Metriche di Volume e Potenza -->
                <div class="col-6">
                    <div class="card p-3 stats-box h-100">
                        <i class="bi bi-geo-alt stats-icon h3 text-muted"></i>
                        <small class="text-muted d-block">Volume Totale</small>
                        <span class="h4 fw-bold">{{ totale_km }} KM</span>
                        
                        <div class="d-flex justify-content-center gap-2 mt-1">
                            <div class="small bg-light rounded px-2 py-1">
                                <span class="fw-bold text-dark">{{ dislivello_totale }}m</span> 
                                <span class="text-muted" style="font-size: 0.65rem;">D+ Tot</span>
                            </div>
                            <div class="small bg-light rounded px-2 py-1">
                                <span class="fw-bold text-success">+{{ dislivello_settimanale }}m</span> 
                                <span class="text-muted" style="font-size: 0.65rem;">D+ Week</span>
                            </div>
                        </div>

                        {% if trends.distanza is not None %}
                            <div class="small fw-bold mt-2 pt-2 border-top {% if trends.distanza > 0 %}text-success{% else %}text-muted{% endif %}">
                                {% if trends.distanza > 0 %}<i class="bi bi-arrow-up-right"></i>{% elif trends.distanza < 0 %}<i class="bi bi-arrow-down-right"></i>{% endif %}
                                {{ trends.distanza }}%
                                <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                                <span class="text-muted fw-normal" style="font-size: 0.7rem;">(Vol. Recente)</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 stats-box h-100">
                        <i class="bi bi-calendar-check stats-icon h3 text-muted"></i>
                        <small class="text-muted d-block">Volume Anno {% now "Y" %}</small>
                        <span class="h4 fw-bold">{{ annuale_km }} KM</span>
                        
                        <div class="d-flex justify-content-center gap-2 mt-1">
                            <div class="small bg-light rounded px-2 py-1">
                                <span class="fw-bold text-dark">{{ dislivello_annuale }}m</span> 
                                <span class="text-muted" style="font-size: 0.65rem;">D+ Anno</span>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-top">
                             <small class="text-muted d-block" style="font-size: 0.7rem;">Media Settimanale</small>
                             <div class="fw-bold text-dark" style="font-size: 0.9rem;">
                                {{ avg_weekly_km }} km <span class="text-muted fw-normal">/</span> {{ avg_weekly_elev }} m
                             </div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 stats-box h-100" style="border-color: #ffc107;">
                        <i class="bi bi-graph-up-arrow h3 text-warning"></i>
                        <small class="text-muted d-block">
                            VAM (m/h)
                            <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ vam_tooltip }}"></i>
                        </small>
                        <span class="h4 fw-bold text-warning">{{ vam_media }}</span>
                        {% if trends.vam is not None %}
                            <div class="small fw-bold mt-1 {% if trends.vam > 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if trends.vam > 0 %}<i class="bi bi-arrow-up-right"></i>{% elif trends.vam < 0 %}<i class="bi bi-arrow-down-right"></i>{% endif %}
                                {{ trends.vam }}%
                                <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                            </div>
                        {% endif %}
                        {% if vam_media > 0 %}<div class="small fw-bold text-uppercase mt-1" style="color: #ffc107; font-size: 0.8rem; letter-spacing: 1px;">{{ livello_vam }}</div>{% endif %}
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 stats-box h-100" style="border-color: #6610f2;">
                        <i class="bi bi-lightning h3" style="color: #6610f2;"></i>
                        <small class="text-muted d-block">Potenza (W)</small>
                        <span class="h4 fw-bold" style="color: #6610f2;">{{ potenza_media }}</span>
                        {% if trends.potenza is not None %}
                            <div class="small fw-bold mt-1 {% if trends.potenza > 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if trends.potenza > 0 %}<i class="bi bi-arrow-up-right"></i>{% elif trends.potenza < 0 %}<i class="bi bi-arrow-down-right"></i>{% endif %}
                                {{ trends.potenza }}%
                                <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                            </div>
                        {% endif %}
                        {% if potenza_media > 0 %}<div class="small fw-bold text-uppercase mt-1" style="color: #6610f2; font-size: 0.8rem; letter-spacing: 1px;">{{ livello_potenza }}</div>{% endif %}
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4 text-center">
                <!-- Riga 2: Passo e FC -->
                <div class="col-6">
                    <div class="card p-3 stats-box h-100">
                        <i class="bi bi-stopwatch h3 text-primary"></i>
                        <small class="text-muted d-block">Passo Medio</small>
                        <span class="h4 fw-bold text-primary">{{ passo_media_recent }}</span>
                        {% if trends.passo is not None %}
                            <div class="small fw-bold mt-1 {% if trends.passo > 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if trends.passo > 0 %}<i class="bi bi-arrow-up-right"></i>{% elif trends.passo < 0 %}<i class="bi bi-arrow-down-right"></i>{% endif %}
                                {{ trends.passo }}%
                                <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                                <span class="text-muted fw-normal" style="font-size: 0.7rem;">(Velocità)</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 stats-box h-100">
                        <i class="bi bi-heart h3 text-danger"></i>
                        <small class="text-muted d-block">FC Media</small>
                        <span class="h4 fw-bold text-danger">{{ fc_media_recent }} bpm</span>
                        {% if trends.fc_media is not None %}
                            <div class="small fw-bold mt-1 {% if trends.fc_media < 0 %}text-success{% else %}text-muted{% endif %}">
                                {% if trends.fc_media > 0 %}<i class="bi bi-arrow-up-right"></i>{% elif trends.fc_media < 0 %}<i class="bi bi-arrow-down-right"></i>{% endif %}
                                {{ trends.fc_media }}%
                                <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Riga 2: Metriche Fisiologiche -->
                <div class="col-6">
                    <div class="card p-3 stats-box h-100" style="border-color: #dc3545;">
                        <i class="bi bi-heart-pulse h3 text-danger"></i>
                        <small class="text-muted d-block">
                            VO2max Stima Statistica
                            <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Media mobile (ultime 60 attività). Include Trail (con regola Km-Sforzo: 100m D+ = 500m piani + 5% penalità tecnica) e Strada."></i>
                        </small>
                        {% if profilo.vo2max_stima_statistica %}
                            <span class="h4 fw-bold text-danger">{{ profilo.vo2max_stima_statistica }}</span>
                            {% if trends.vo2max is not None %}
                                <span class="small ms-2 {% if trends.vo2max > 0 %}text-success{% elif trends.vo2max < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if trends.vo2max > 0 %}▲{% elif trends.vo2max < 0 %}▼{% endif %}
                                    {{ trends.vo2max }}%
                                    <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                                </span>
                            {% endif %}
                            <div class="small fw-bold text-uppercase mt-1" style="color: #dc3545; font-size: 0.8rem; letter-spacing: 1px;">{{ livello_vo2max }}</div>
                        {% else %}
                            <span class="h4 fw-bold text-danger">--</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 stats-box h-100" style="border-color: #0d6efd;">
                        <i class="bi bi-speedometer2 h3 text-primary"></i>
                        <small class="text-muted d-block">
                            VO2max Solo Strada
                            <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Media mobile (ultime 60 attività solo Strada). Calcolato con formula scientifica ACSM pura su asfalto."></i>
                        </small>
                        {% if profilo.vo2max_strada %}
                            <span class="h4 fw-bold text-primary">{{ profilo.vo2max_strada }}</span>
                            {% if trends.vo2max_strada is not None %}
                                <span class="small ms-2 {% if trends.vo2max_strada > 0 %}text-success{% elif trends.vo2max_strada < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if trends.vo2max_strada > 0 %}▲{% elif trends.vo2max_strada < 0 %}▼{% endif %}
                                    {{ trends.vo2max_strada }}%
                                    <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                                </span>
                            {% endif %}
                            <div class="small fw-bold text-uppercase mt-1" style="color: #0d6efd; font-size: 0.8rem; letter-spacing: 1px;">{{ livello_vo2max_strada }}</div>
                        {% else %}
                            <span class="h4 fw-bold text-primary">--</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Indici Internazionali -->
            {% if profilo.indice_itra > 0 or profilo.indice_utmb > 0 %}
            <div class="row g-3 mb-4">
                {% if profilo.indice_itra > 0 %}
                <div class="col-md-6">
                    <div class="card p-3 text-center text-white shadow-sm" style="background-color: #2c3e50;">
                        <small class="d-block text-uppercase opacity-75 fw-bold">ITRA Index</small>
                        <span class="display-6 fw-bold">{{ profilo.indice_itra }}</span>
                        <div class="fw-bold text-uppercase mt-2" style="font-size: 0.9rem; letter-spacing: 1px; opacity: 0.9;">{{ livello_itra }}</div>
                    </div>
                </div>
                {% endif %}
                {% if profilo.indice_utmb > 0 %}
                <div class="col-md-6">
                    <div class="card p-3 text-center text-black shadow-sm" style="background-color: #ffc107;">
                        <small class="d-block text-uppercase opacity-75 fw-bold">UTMB Index</small>
                        <span class="display-6 fw-bold">{{ profilo.indice_utmb }}</span>
                        <div class="fw-bold text-uppercase mt-2" style="font-size: 0.9rem; letter-spacing: 1px; opacity: 0.8;">{{ livello_utmb }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Grafici Dashboard -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card p-3 h-100 shadow-sm">
                        <h6 class="fw-bold text-muted mb-3 small text-uppercase">Frequenza Cardiaca (bpm)</h6>
                        <canvas id="chartFC"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-3 h-100 shadow-sm">
                        <h6 class="fw-bold text-muted mb-3 small text-uppercase">Passo Medio (min/km)</h6>
                        <canvas id="chartPace"></canvas>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card p-3 shadow-sm">
                        <h6 class="fw-bold text-muted mb-3 small text-uppercase">Volume (Distanza & Dislivello)</h6>
                        <canvas id="chartDistElev" height="300"></canvas>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card p-3 shadow-sm">
                        <h6 class="fw-bold text-muted mb-3 small text-uppercase">Potenza Media (Watt)</h6>
                        <canvas id="chartPower" height="300"></canvas>
                    </div>
                </div>
            </div>

            <div class="card p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-calendar3 me-2"></i>Ultime Sessioni</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>KM</th>
                                <th>Passo</th>
                                <th>D+</th>
                                <th>VAM</th>
                                <th>Kcal</th>
                                <th>VO2 Abs</th>
                                <th>FC Media</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for act in attivita_recenti %}
                            <tr>
                                <td class="small">{{ act.data|date:"d/m/Y" }}</td>
                                <td>
                                    {% if act.tipo_attivita == "TrailRun" %}
                                        <i class="bi bi-mountain text-success me-1"></i> Trail
                                    {% else %}
                                        <i class="bi bi-signpost-split text-primary me-1"></i> Strada
                                    {% endif %}
                                </td>
                                <td class="fw-bold">{{ act.distanza_km }}</td>
                                <td>{{ act.passo_medio }}</td>
                                <td><span class="text-muted">+{{ act.dislivello|floatformat:0 }}m</span></td>
                                <td><span class="fw-bold text-warning">{{ act.vam }} m/h</span></td>
                                <td>{{ act.kcal_stimate|default:"--" }}</td>
                                <td><span class="text-primary fw-bold">{{ act.vo2max_assoluto|default:"--" }}</span> <small class="text-muted">L/min</small></td>
                                <td><span class="badge bg-light text-dark">{{ act.fc_media }} bpm</span></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-center py-4">Nessuna attività trovata. Sincronizza con Strava.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

<!-- Modal Analisi AI Personale -->
<div class="modal fade" id="aiPersonalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-robot me-2"></i>Analisi Performance AI</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="aiPersonalLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted">Gemini sta analizzando le tue ultime 3 settimane...</p>
                </div>
                
                <!-- Contenitore per il PDF -->
                <div id="aiPersonalContent" class="d-none bg-white p-5">
                    <div class="text-center mb-5 border-bottom pb-4">
                        <h1 class="fw-bold text-primary mb-2"><i class="bi bi-graph-up-arrow me-2"></i>Performance Report</h1>
                        <p class="text-muted h5">Analisi Avanzata & Suggerimenti Coach AI</p>
                    </div>
                    
                    <div class="row mb-5">
                        <div class="col-6">
                            <h5 class="fw-bold text-uppercase text-secondary mb-3">Profilo Atleta</h5>
                            <ul class="list-unstyled">
                                <li class="mb-2"><strong>Nome:</strong> {{ profilo.user.first_name }} {{ profilo.user.last_name }}</li>
                                <li class="mb-2"><strong>Categoria:</strong> {{ livello_vo2max|default:"N/A" }}</li>
                                <li><strong>Data Report:</strong> <span id="reportDate"></span></li>
                            </ul>
                        </div>
                        <div class="col-6 text-end">
                            <div class="p-3 bg-light rounded d-inline-block text-start" style="min-width: 200px;">
                                <small class="d-block text-muted text-uppercase">VO2max Attuale</small>
                                <div class="display-6 fw-bold text-primary">{{ profilo.vo2max_stima_statistica|default:"--" }}</div>
                                <small class="text-success"><i class="bi bi-activity"></i> ml/kg/min</small>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 rounded-3" style="background-color: #f8f9fa; border-left: 5px solid #0d6efd;">
                        <h4 class="fw-bold mb-4"><i class="bi bi-robot me-2"></i>Analisi Tecnica</h4>
                        <div id="aiPersonalText" style="font-family: 'Segoe UI', sans-serif; line-height: 1.8; font-size: 1.05rem; color: #333;"></div>
                    </div>

                    <div class="mt-5 pt-4 border-top text-center text-muted small">
                        <p class="mb-1">Barilla Monitor System • Powered by Strava & Gemini AI</p>
                        <p>Generato il <span id="reportDateFooter"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <button type="button" class="btn btn-danger" onclick="scaricaPDFPersonale()"><i class="bi bi-file-earmark-pdf me-2"></i>Scarica PDF</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Loading Sync -->
<div class="modal fade" id="syncModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="modal-body">
                <h4 class="fw-bold mb-3">Sincronizzazione in corso...</h4>
                <div class="progress mb-3" style="height: 25px;">
                    <div id="syncProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning text-dark fw-bold" role="progressbar" style="width: 0%">0%</div>
                </div>
                <p id="syncStatusText" class="text-muted mb-0">Inizializzazione connessione...</p>
                <p class="small text-warning mt-3 bg-light p-2 rounded"><i class="bi bi-info-circle-fill me-1"></i>Se è il primo download, l'operazione potrebbe richiedere alcuni minuti. Non chiudere la pagina.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    // Inizializzazione Tooltip Bootstrap
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

    // Configurazione Grafici
    const labels = {{ chart_labels|safe }};
    const commonOptions = {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { x: { grid: { display: false } } }
    };

    // 1. FC Media
    new Chart(document.getElementById('chartFC'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{ data: {{ chart_fc|safe }}, borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.1)', tension: 0.3, fill: true }]
        },
        options: commonOptions
    });

    // 2. Passo Medio
    new Chart(document.getElementById('chartPace'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{ data: {{ chart_pace|safe }}, borderColor: '#0d6efd', backgroundColor: 'rgba(13, 110, 253, 0.1)', tension: 0.3, fill: true }]
        },
        options: commonOptions // Ripristinato: asse standard come richiesto
    });

    // 3. Distanza & Dislivello (Combinato)
    new Chart(document.getElementById('chartDistElev'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Distanza (km)',
                    data: {{ chart_dist|safe }},
                    backgroundColor: '#198754',
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 2
                },
                {
                    label: 'Dislivello (m)',
                    data: {{ chart_elev|safe }},
                    type: 'line',
                    borderColor: '#6c757d',
                    backgroundColor: 'rgba(108, 117, 125, 0.2)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    yAxisID: 'y1',
                    order: 1
                }
            ]
        },
        options: {
            ...commonOptions,
            plugins: { legend: { display: true } },
            scales: {
                x: { grid: { display: false } },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'km' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'm' }
                }
            }
        }
    });

    // 5. Potenza
    new Chart(document.getElementById('chartPower'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{ data: {{ chart_power|safe }}, borderColor: '#6610f2', backgroundColor: 'rgba(102, 16, 242, 0.1)', tension: 0.3, fill: true }]
        },
        options: commonOptions
    });

    let isReloading = false;

    // Funzione per avviare il sync e mostrare il modal
    function startSyncRedirect(event) {
        // Impediamo il reindirizzamento immediato del link
        event.preventDefault();
        
        const syncUrl = event.currentTarget.getAttribute('href');
        
        // Reset UI del Modal
        const progressBar = document.getElementById('syncProgressBar');
        const statusText = document.getElementById('syncStatusText');
        progressBar.style.width = '1%';
        progressBar.innerText = '';
        statusText.innerText = 'Contatto il server...';

        // Aggiungiamo timestamp per evitare che il browser usi la cache (es. redirect precedente)
        const uniqueUrl = syncUrl + (syncUrl.includes('?') ? '&' : '?') + '_t=' + new Date().getTime();

        // 1. Avvia la sincronizzazione in background
        fetch(uniqueUrl, { cache: "no-store", credentials: "include" })
            .then(response => {
                // Se il server ci ha reindirizzato al login (token scaduto), andiamo lì
                if (response.url && response.url.includes('login')) {
                    window.location.href = response.url;
                    return;
                }
                // Quando finisce, ricarica la pagina
                isReloading = true;
                window.location.reload();
            })
            .catch(error => {
                console.error("Errore sync:", error);
                // Mostriamo l'errore nel modal invece di ricaricare subito
                statusText.innerText = "Errore di connessione: " + error.message;
                statusText.classList.add('text-danger');
                progressBar.classList.remove('bg-warning');
                progressBar.classList.add('bg-danger');
            });

        // 2. Avvia il polling per aggiornare la barra (ogni 1s)
        const intervalId = setInterval(() => {
            fetch('/?sync_status=true', { credentials: "include" })
                .then(response => {
                    if (!response.ok) return null;
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    progressBar.style.width = data.progress + '%';
                    progressBar.innerText = data.progress + '%';
                    if (data.status) statusText.innerText = data.status;
                    if (data.progress >= 100) clearInterval(intervalId);
                });
        }, 1000);
    }

    window.addEventListener('beforeunload', function (e) {
        if (isReloading) return;

        // Mostra un avviso solo se il modal di sync è visibile
        var modal = document.getElementById('syncModal');
        if (modal && modal.classList.contains('show')) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Funzioni Analisi AI Personale
    function generaAnalisiPersonale() {
        const modal = new bootstrap.Modal(document.getElementById('aiPersonalModal'));
        modal.show();
        
        document.getElementById('aiPersonalLoading').classList.remove('d-none');
        document.getElementById('aiPersonalContent').classList.add('d-none');
        
        // Imposta la data odierna nel report
        const today = new Date().toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
        const reportDateEl = document.getElementById('reportDate');
        if(reportDateEl) reportDateEl.textContent = today;
        const reportDateFooterEl = document.getElementById('reportDateFooter');
        if(reportDateFooterEl) reportDateFooterEl.textContent = today;

        // Passiamo username per supportare la vista admin su altri atleti
        fetch("{% url 'analisi_gemini' %}?api=true&username={{ profilo.user.username }}")
            .then(response => response.json())
            .then(data => {
                document.getElementById('aiPersonalLoading').classList.add('d-none');
                const contentDiv = document.getElementById('aiPersonalContent');
                const textDiv = document.getElementById('aiPersonalText');
                contentDiv.classList.remove('d-none');
                
                // Formattazione Markdown base
                let formatted = data.analisi.replace(/\*\*(.*?)\*\*/g, '<strong class="text-primary">$1</strong>'); // Bold
                formatted = formatted.replace(/## (.*)/g, '<h5 class="fw-bold mt-4 mb-2 border-bottom pb-1">$1</h5>'); // Headers
                formatted = formatted.replace(/\n/g, '<br>');
                textDiv.innerHTML = formatted;
            })
            .catch(error => {
                document.getElementById('aiPersonalLoading').classList.add('d-none');
                document.getElementById('aiPersonalContent').classList.remove('d-none');
                document.getElementById('aiPersonalText').innerHTML = `<div class="alert alert-danger">Errore durante l'analisi: ${error}</div>`;
            });
    }

    function scaricaPDFPersonale() {
        const element = document.getElementById('aiPersonalContent');
        const opt = {
            margin: [10, 10],
            filename: 'Report_Performance_{{ profilo.user.username }}.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>
{% endblock %}