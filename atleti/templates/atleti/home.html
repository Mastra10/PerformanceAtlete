{% extends 'base.html' %}
{% load socialaccount %}
{% load static %}

{% block extra_css %}
<style>
    /* Stile Login Full Screen */
    body, html {
        height: 100%;
        margin: 0;
        font-family: 'Inter', sans-serif;
    }

    .bg-image {
        background-image: url("{% static 'images/Mastra.png' %}");
        height: 100vh;
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
        position: relative;
    }

    .overlay {
        background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7));
        height: 100%;
        width: 100%;
        display: flex;
        align-items: flex-end;
        justify-content: flex-end;
        padding-right: 5%;
        padding-bottom: 5%;
    }

    .login-box {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        text-align: center;
        width: 90%;
        max-width: 400px;
    }

    .strava-btn {
        display: inline-block;
        margin-top: 20px;
        transition: transform 0.2s;
    }

    .strava-btn:hover {
        transform: scale(1.05);
    }

    @media (max-width: 768px) {
        .overlay {
            justify-content: center;
            align-items: center;
            padding-right: 0;
            padding-bottom: 0;
        }
    }

    /* FIX NAVBAR MOBILE: Rende visibile il menu a tendina su cellulare */
    @media (max-width: 991.98px) {
        .navbar-collapse {
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
            margin-top: 0.5rem;
            z-index: 1050; /* Assicura che stia sopra a tutto */
        }
    }
</style>
{% endblock %}

{% block content_unauth %}
<div class="bg-image">
    <div class="overlay">
        <div class="login-box">
            <p class="lead text-muted">Monitora i tuoi progressi, contribuisci al successo del gruppo.</p>
            <hr class="my-4">
            <a href="{% provider_login_url 'strava' %}" class="strava-btn">
                <img src="{% static 'images/btn_strava_connect_with_orange.svg' %}" alt="Connect with Strava" width="237" height="48">
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
    {% if error_message %}
        <div class="alert alert-warning text-center my-5">
            <i class="bi bi-lock-fill display-1 d-block mb-3"></i>
            <h4>{{ error_message }}</h4>
        </div>
    {% else %}
    
    {% if request.session.impersonator %}
    <div class="alert alert-danger text-center fw-bold shadow-sm border-danger">
        <i class="bi bi-mask me-2"></i> MODALITÀ IMPERSONIFICAZIONE ATTIVA
        <span class="fw-normal d-block small mt-1">Stai agendo come <u>{{ request.user.username }}</u> (Admin originale: {{ request.session.impersonator }}). <a href="/accounts/logout/" class="text-danger fw-bold">Logout per uscire</a>.</span>
    </div>
    {% endif %}
    
    {% if warning_peso %}
    <div class="alert alert-warning text-center fw-bold">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ warning_peso }}
    </div>
    {% endif %}
    
    <!-- Notifiche Allenamenti -->
    {% if notifiche_utente %}
    <div id="notifications-container" class="mb-4">
        {% for n in notifiche_utente|slice:":3" %}
        <div class="alert alert-info alert-dismissible fade show shadow-sm border-info" role="alert" id="notifica-{{ n.id }}">
            <i class="bi bi-calendar-check-fill me-2"></i>
            {% if n.link %}<a href="{{ n.link }}" class="alert-link text-decoration-none">{{ n.messaggio }}</a>{% else %}{{ n.messaggio }}{% endif %}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" onclick="segnaLetta({{ n.id }})"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <h2 class="fw-bold mb-4">Dashboard Personale</h2>
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card p-4 text-center mb-4 position-relative">
                <!-- Campanello Novità -->
                <div class="position-absolute top-0 start-0 p-3">
                    <button type="button" class="btn btn-light position-relative rounded-circle shadow-sm border" data-bs-toggle="modal" data-bs-target="#newsModal">
                        <i class="bi bi-megaphone-fill text-primary"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary border border-light">
                            1
                            <span class="visually-hidden">novità</span>
                        </span>
                    </button>
                </div>

                <!-- Notifiche (Messaggi + Allarmi) -->
                {% if allarmi or notifiche_utente|length > 3 %}
                <div class="position-absolute top-0 end-0 p-3 d-flex gap-2">
                    {% if notifiche_utente|length > 3 %}
                    <button type="button" class="btn btn-light position-relative rounded-circle shadow-sm border" data-bs-toggle="modal" data-bs-target="#messagesModal" title="Altre notifiche">
                        <i class="bi bi-envelope-paper-fill text-warning"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-light">
                            +{{ notifiche_utente|length|add:"-3" }}
                            <span class="visually-hidden">notifiche</span>
                        </span>
                    </button>
                    {% endif %}

                    {% if allarmi %}
                    <button type="button" class="btn btn-light position-relative rounded-circle shadow-sm border" data-bs-toggle="modal" data-bs-target="#alarmsModal">
                        <i class="bi bi-bell-fill text-danger shake-animation"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-light">
                            {{ allarmi|length }}
                            <span class="visually-hidden">allarmi</span>
                        </span>
                    </button>
                    {% endif %}
                </div>
                {% endif %}

                <div class="mb-3">
                    {% if profilo.immagine_profilo %}
                        <img src="{{ profilo.immagine_profilo }}" alt="Profilo Strava" class="rounded-circle shadow-sm" style="width: 120px; height: 120px; object-fit: cover; border: 4px solid var(--barilla-blue);">
                    {% else %}
                        <i class="bi bi-person-circle display-1 text-secondary"></i>
                    {% endif %}
                </div>
                <h3 class="fw-bold m-0">
                    {{ profilo.user.first_name }} {{ profilo.user.last_name }}
                    {% if profilo.user.is_staff or request.user.is_staff and profilo.user.id == request.user.id %}
                        <span class="badge bg-dark align-middle ms-2" style="font-size: 0.6em;">ADMIN</span>
                    {% endif %}
                </h3>
                <small class="text-muted">(@{{ profilo.user.username }})</small>
                <div class="badge bg-success my-3">Atleta</div>
                <hr>
                <div class="row text-start g-2">
                    <div class="col-6 border-end text-center">
                        <small class="text-muted d-block">Peso</small>
                        <span class="h5 fw-bold">{{ profilo.peso|default:"--" }} kg</span>
                    </div>
                    <div class="col-6 text-center">
                        <small class="text-muted d-block">FC Max</small>
                        <span class="h5 fw-bold text-danger">{{ profilo.fc_massima_teorica }} bpm</span>
                        <div class="small text-muted" style="font-size: 0.7rem;">
                            {% if profilo.fc_max_manuale %}
                                (Impostata a mano)
                            {% elif profilo.data_fc_max %}
                                {{ profilo.data_fc_max|date:"d/m/Y" }}
                            {% else %}
                                <span class="text-muted" title="Data non disponibile. Sincronizza Strava.">--/--/----</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row text-start g-2">
                    <div class="col-6 border-end text-center">
                        <small class="text-muted d-block">ITRA Index</small>
                        <span class="h5 fw-bold" style="color: #2c3e50;">{{ profilo.indice_itra|default:"--" }}</span>
                        {% if profilo.indice_itra > 0 %}<div class="small fw-bold text-uppercase mt-1" style="color: #2c3e50; font-size: 0.7rem;">{{ livello_itra }}</div>{% endif %}
                    </div>
                    <div class="col-6 text-center">
                        <small class="text-muted d-block">UTMB Index</small>
                        <span class="h5 fw-bold" style="color: #ffc107;">{{ profilo.indice_utmb|default:"--" }}</span>
                        {% if profilo.indice_utmb > 0 %}<div class="small fw-bold text-uppercase mt-1" style="color: #ffc107; font-size: 0.7rem;">{{ livello_utmb }}</div>{% endif %}
                    </div>
                </div>
                <hr>
                <div class="row text-start g-2">
                    <div class="col-6 border-end text-center">
                        <small class="text-muted d-block">Soglia Aerobica</small>
                        <span class="h5 fw-bold text-success">{{ soglia_aerobica }} bpm</span>
                        <div class="small text-muted" style="font-size: 0.7rem;">Stima Fondo (Z2)</div>
                    </div>
                    <div class="col-6 text-center">
                        <small class="text-muted d-block">Soglia Anaerobica</small>
                        <span class="h5 fw-bold text-danger">{{ soglia_anaerobica }} bpm</span>
                        <div class="small text-muted" style="font-size: 0.7rem;">Stima Soglia (Z4)</div>
                    </div>
                </div>
                <hr>
                <div class="row text-start g-2">
                    <div class="col-6 border-end text-center">
                        <small class="text-muted d-block">Passo Medio</small>
                        <span class="h5 fw-bold text-primary">{{ passo_media_recent }}</span>
                        <div class="small text-muted" style="font-size: 0.7rem;">Recente</div>
                    </div>
                    <div class="col-6 text-center">
                        <small class="text-muted d-block">FC Media</small>
                        <span class="h5 fw-bold text-danger">{{ fc_media_recent }} bpm</span>
                        <div class="small text-muted" style="font-size: 0.7rem;">Recente</div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold m-0"><i class="bi bi-sliders me-2"></i>Controlli</h5>
                </div>
                <div class="card-body p-4">
                <a href="{% url 'impostazioni' %}" class="btn btn-outline-dark btn-sm w-100 mb-2"><i class="bi bi-gear-fill me-1"></i> Impostazioni</a>
                <a href="{% url 'strava_sync' %}" 
                   data-bs-toggle="modal" 
                   data-bs-target="#syncModal" 
                   onclick="startSyncRedirect(event)"
                   class="btn btn-outline-secondary btn-sm w-100">
                    <i class="bi bi-arrow-repeat me-1"></i>Sincronizza Strava
                </a>
                <a href="{% url 'ricalcola_statistiche' %}" class="btn btn-outline-primary btn-sm w-100 mt-2">
                    <i class="bi bi-calculator me-1"></i>Ricalcola Dati
                </a>
                <a href="{% url 'export_csv' %}" class="btn btn-outline-success btn-sm w-100 mt-2">
                    <i class="bi bi-download me-1"></i>Scarica Attività CSV
                </a>
                <a href="{% url 'export_profile_csv' %}" class="btn btn-outline-success btn-sm w-100 mt-2">
                    <i class="bi bi-file-earmark-person me-1"></i>Scarica Profilo CSV
                </a>
                <a href="{% url 'guida_utente' %}" class="btn btn-outline-info btn-sm w-100 mt-2">
                    <i class="bi bi-book-half me-1"></i>Guida & Metriche
                </a>
                <button onclick="generaAnalisiPersonale()" class="btn btn-primary btn-sm w-100 mt-2 shadow-sm">
                    <i class="bi bi-stars me-1"></i>Analisi AI Personalizzata
                </button>
                
                <div class="mt-3 small text-muted text-center border-top pt-2">
                    <div class="mb-1">
                        <i class="bi bi-clock-history me-1"></i>Ultima Sync:<br>
                        <span class="fw-bold text-dark">
                            {% if profilo.data_ultima_sincronizzazione %}{{ profilo.data_ultima_sincronizzazione|date:"d/m H:i" }}{% else %}--{% endif %}
                        </span>
                    </div>
                    <div>
                        <i class="bi bi-calculator me-1"></i>Ultimo Ricalcolo:<br>
                        <span class="fw-bold text-dark">
                            {% if profilo.data_ultimo_ricalcolo_statistiche %}{{ profilo.data_ultimo_ricalcolo_statistiche|date:"d/m H:i" }}{% else %}--{% endif %}
                        </span>
                    </div>
                </div>
                
                {% if request.user.is_staff %}
                <hr>
                <small class="text-muted fw-bold text-uppercase mb-2 d-block">Admin Zone</small>
                <a href="{% url 'scheduler_logs' %}" class="btn btn-outline-info btn-sm w-100">
                    <i class="bi bi-list-task me-1"></i>Log Scheduler
                </a>
                {% endif %}
                
                {% if user.is_staff or perms.atleti.access_coach_dashboard %}
                <a href="{% url 'dashboard_coach' %}" class="btn btn-outline-primary btn-sm w-100 mt-2">
                    <i class="bi bi-speedometer2 me-1"></i>Dashboard Coach
                </a>
                {% endif %}

                <!-- DEBUG INFO (Rimuovere in produzione) -->
                <div class="mt-3 p-2 bg-light border small text-muted">
                    User: <strong>{{ request.user.username }}</strong><br>
                    Staff: <strong class="{% if request.user.is_staff %}text-success{% else %}text-danger{% endif %}">{{ request.user.is_staff }}</strong>
                </div>
                </div>
            </div>

            <!-- Sezione Scarpe nella Dashboard -->
            {% if user.is_staff or perms.atleti.access_attrezzatura %}
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="m-0"><i class="bi bi-shop"></i> Le tue Scarpe</h5>
                    <a href="{% url 'attrezzatura_scarpe' %}" class="btn btn-sm btn-outline-primary">Vedi Statistiche</a>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <!-- Scarpe Attive -->
                        {% for s in user_shoes %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                {% if s.logo_url %}
                                    <img src="{{ s.logo_url }}" alt="{{ s.brand }}" style="height: 20px; width: 40px; object-fit: contain;" class="me-2" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                    <span class="fw-bold me-2" style="display:none;">{{ s.brand }}</span>
                                {% else %}
                                    <span class="fw-bold me-2">{{ s.brand }}</span>
                                {% endif %}
                                <div>
                                    <span class="fw-bold">{{ s.nome }}</span>
                                    {% if s.primary %}<span class="badge bg-primary ms-1" style="font-size: 0.6em;">MAIN</span>{% endif %}
                                </div>
                            </div>
                            <span class="badge bg-light text-dark border">{{ s.distanza_km }} km</span>
                        </li>
                        {% endfor %}

                        <!-- Scarpe Dismesse (Titolo se presenti) -->
                        {% if retired_shoes %}
                        <li class="list-group-item bg-light text-muted small fw-bold text-uppercase mt-2">
                            <i class="bi bi-archive me-1"></i> Dismesse / Ritirate
                        </li>
                        {% for s in retired_shoes %}
                        <li class="list-group-item d-flex justify-content-between align-items-center text-muted" style="background-color: #fcfcfc;">
                            <div class="d-flex align-items-center">
                                {% if s.logo_url %}
                                    <img src="{{ s.logo_url }}" alt="{{ s.brand }}" style="height: 18px; width: 40px; object-fit: contain; opacity: 0.6;" class="me-2" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                    <span class="me-2" style="display:none;">{{ s.brand }}</span>
                                {% else %}
                                    <span class="me-2">{{ s.brand }}</span>
                                {% endif %}
                                <span>{{ s.nome }}</span>
                            </div>
                            <span class="small">{{ s.distanza_km }} km</span>
                        </li>
                        {% endfor %}
                        {% endif %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-8">
            <div class="row g-3 mb-4 text-center">
                <!-- Riga 1: Metriche di Volume e Potenza -->
                <div class="col-6">
                    <div class="card p-3 stats-box h-100">
                        <i class="bi bi-geo-alt stats-icon h3 text-muted"></i>
                        <small class="text-muted d-block">Volume Totale</small>
                        <span class="h4 fw-bold">{{ totale_km }} KM</span>
                        
                        <div class="d-flex justify-content-center gap-2 mt-1">
                            <div class="small bg-light rounded px-2 py-1">
                                <span class="fw-bold text-dark">{{ dislivello_totale }}m</span> 
                                <span class="text-muted" style="font-size: 0.65rem;">D+ Tot</span>
                            </div>
                            <div class="small bg-light rounded px-2 py-1">
                                <span class="fw-bold text-success">+{{ dislivello_settimanale }}m</span> 
                                <span class="text-muted" style="font-size: 0.65rem;">D+ Week</span>
                            </div>
                        </div>

                        {% if trends.distanza is not None %}
                            <div class="small fw-bold mt-2 pt-2 border-top {% if trends.distanza > 0 %}text-success{% else %}text-muted{% endif %}">
                                {% if trends.distanza > 0 %}<i class="bi bi-arrow-up-right"></i>{% elif trends.distanza < 0 %}<i class="bi bi-arrow-down-right"></i>{% endif %}
                                {{ trends.distanza }}%
                                <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                                <span class="text-muted fw-normal" style="font-size: 0.7rem;">(Vol. Recente)</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 stats-box h-100">
                        <i class="bi bi-calendar-check stats-icon h3 text-muted"></i>
                        <small class="text-muted d-block">Volume Anno {% now "Y" %}</small>
                        <span class="h4 fw-bold">{{ annuale_km }} KM</span>
                        
                        <div class="d-flex justify-content-center gap-2 mt-1">
                            <div class="small bg-light rounded px-2 py-1">
                                <span class="fw-bold text-dark">{{ dislivello_annuale }}m</span> 
                                <span class="text-muted" style="font-size: 0.65rem;">D+ Anno</span>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-top">
                             <small class="text-muted d-block" style="font-size: 0.7rem;">Media Settimanale</small>
                             <div class="fw-bold text-dark" style="font-size: 0.9rem;">
                                {{ avg_weekly_km }} km <span class="text-muted fw-normal">/</span> {{ avg_weekly_elev }} m
                             </div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 stats-box h-100" style="border-color: #ffc107;">
                        <i class="bi bi-graph-up-arrow h3 text-warning"></i>
                        <small class="text-muted d-block">
                            VAM (m/h)
                            <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ vam_tooltip }}"></i>
                        </small>
                        <span class="h4 fw-bold text-warning">{{ vam_media }}</span>
                        {% if trends.vam is not None %}
                            <div class="small fw-bold mt-1 {% if trends.vam > 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if trends.vam > 0 %}<i class="bi bi-arrow-up-right"></i>{% elif trends.vam < 0 %}<i class="bi bi-arrow-down-right"></i>{% endif %}
                                {{ trends.vam }}%
                                <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                            </div>
                        {% endif %}
                        {% if vam_media > 0 %}<div class="small fw-bold text-uppercase mt-1" style="color: #ffc107; font-size: 0.8rem; letter-spacing: 1px;">{{ livello_vam }}</div>{% endif %}
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 stats-box h-100" style="border-color: #6610f2;">
                        <i class="bi bi-lightning h3" style="color: #6610f2;"></i>
                        <small class="text-muted d-block">Potenza (W/kg)</small>
                        {% if potenza_media_wkg %}
                            <span class="h4 fw-bold" style="color: #6610f2;">{{ potenza_media_wkg }}</span>
                            <div class="small text-muted" style="font-size: 0.7rem;">{{ potenza_media }} Watt</div>
                        {% else %}
                            <span class="h4 fw-bold" style="color: #6610f2;">{{ potenza_media }} W</span>
                        {% endif %}
                        {% if trends.potenza is not None %}
                            <div class="small fw-bold mt-1 {% if trends.potenza > 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if trends.potenza > 0 %}<i class="bi bi-arrow-up-right"></i>{% elif trends.potenza < 0 %}<i class="bi bi-arrow-down-right"></i>{% endif %}
                                {{ trends.potenza }}%
                                <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                            </div>
                        {% endif %}
                        {% if potenza_media > 0 %}<div class="small fw-bold text-uppercase mt-1" style="color: #6610f2; font-size: 0.8rem; letter-spacing: 1px;">{{ livello_potenza }}</div>{% endif %}
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4 text-center">
                <!-- Riga 2: Passo e FC -->
                <div class="col-6">
                    <div class="card p-3 stats-box h-100">
                        <i class="bi bi-stopwatch h3 text-primary"></i>
                        <small class="text-muted d-block">Passo Medio</small>
                        <span class="h4 fw-bold text-primary">{{ passo_media_recent }}</span>
                        {% if trends.passo is not None %}
                            <div class="small fw-bold mt-1 {% if trends.passo > 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if trends.passo > 0 %}<i class="bi bi-arrow-up-right"></i>{% elif trends.passo < 0 %}<i class="bi bi-arrow-down-right"></i>{% endif %}
                                {{ trends.passo }}%
                                <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                                <span class="text-muted fw-normal" style="font-size: 0.7rem;">(Velocità)</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 stats-box h-100">
                        <i class="bi bi-heart h3 text-danger"></i>
                        <small class="text-muted d-block">FC Media</small>
                        <span class="h4 fw-bold text-danger">{{ fc_media_recent }} bpm</span>
                        {% if trends.fc_media is not None %}
                            <div class="small fw-bold mt-1 {% if trends.fc_media < 0 %}text-success{% else %}text-muted{% endif %}">
                                {% if trends.fc_media > 0 %}<i class="bi bi-arrow-up-right"></i>{% elif trends.fc_media < 0 %}<i class="bi bi-arrow-down-right"></i>{% endif %}
                                {{ trends.fc_media }}%
                                <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Riga 2: Metriche Fisiologiche -->
                <div class="col-6">
                    <div class="card p-3 stats-box h-100" style="border-color: #dc3545;">
                        <i class="bi bi-heart-pulse h3 text-danger"></i>
                        <small class="text-muted d-block">
                            VO2max Stima Statistica
                            <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Algoritmo Ibrido: 70% Efficienza Strada (Passo/FC) + 30% Potenza/VAM. Include Cap ITRA e penalità per discrepanze W/kg."></i>
                        </small>
                        {% if profilo.vo2max_stima_statistica %}
                            <span class="h4 fw-bold text-danger">{{ profilo.vo2max_stima_statistica }}</span>
                            {% if trends.vo2max is not None %}
                                <span class="small ms-2 {% if trends.vo2max > 0 %}text-success{% elif trends.vo2max < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if trends.vo2max > 0 %}▲{% elif trends.vo2max < 0 %}▼{% endif %}
                                    {{ trends.vo2max }}%
                                    <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                                </span>
                            {% endif %}
                            <div class="small fw-bold text-uppercase mt-1" style="color: #dc3545; font-size: 0.8rem; letter-spacing: 1px;">{{ livello_vo2max }}</div>
                        {% else %}
                            <span class="h4 fw-bold text-danger">--</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 stats-box h-100" style="border-color: #0d6efd;">
                        <i class="bi bi-speedometer2 h3 text-primary"></i>
                        <small class="text-muted d-block">
                            VO2max Solo Strada
                            <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Media mobile (ultime 60 attività solo Strada). Calcolato con formula scientifica ACSM pura su asfalto."></i>
                        </small>
                        {% if profilo.vo2max_strada %}
                            <span class="h4 fw-bold text-primary">{{ profilo.vo2max_strada }}</span>
                            {% if trends.vo2max_strada is not None %}
                                <span class="small ms-2 {% if trends.vo2max_strada > 0 %}text-success{% elif trends.vo2max_strada < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if trends.vo2max_strada > 0 %}▲{% elif trends.vo2max_strada < 0 %}▼{% endif %}
                                    {{ trends.vo2max_strada }}%
                                    <i class="bi bi-info-circle text-muted ms-1" style="font-size: 0.7rem;" data-bs-toggle="tooltip" title="Variazione media ultime 5 attività vs precedenti 15"></i>
                                </span>
                            {% endif %}
                            <div class="small fw-bold text-uppercase mt-1" style="color: #0d6efd; font-size: 0.8rem; letter-spacing: 1px;">{{ livello_vo2max_strada }}</div>
                        {% else %}
                            <span class="h4 fw-bold text-primary">--</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 stats-box h-100" style="border-color: #20c997;">
                        <i class="bi bi-fuel-pump h3" style="color: #20c997;"></i>
                        <small class="text-muted d-block">
                            Efficienza (EF)
                            <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{{ efficienza_tooltip }}"></i>
                        </small>
                        {% if efficienza_media %}
                            <span class="h4 fw-bold" style="color: #20c997;">{{ efficienza_media }}</span>
                            <div class="small fw-bold text-uppercase mt-1" style="color: #20c997; font-size: 0.8rem; letter-spacing: 1px;">{{ livello_efficienza }}</div>
                            <div class="small text-muted mt-1" style="font-size: 0.7rem;">Metri / Battito</div>
                        {% else %}
                            <span class="h4 fw-bold" style="color: #20c997;">--</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Feedback Allenamenti -->
                <div class="col-6">
                    <div class="card p-3 stats-box h-100" style="border-color: #6c757d;">
                        <i class="bi bi-check-circle-fill h3" style="color: #6c757d;"></i>
                        <small class="text-muted d-block">
                            Feedback & Affidabilità
                            <i class="bi bi-info-circle-fill ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Punteggio: +1 Presente, -1 Assente. Affidabilità: % Presenze su Iscrizioni confermate."></i>
                        </small>
                        
                        <div class="d-flex justify-content-center align-items-baseline gap-2">
                            <span class="h4 fw-bold {% if profilo.punteggio_feedback >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if profilo.punteggio_feedback > 0 %}+{% endif %}{{ profilo.punteggio_feedback }}
                            </span>
                            <span class="small text-muted">Punti</span>
                        </div>

                        <div class="mt-2 pt-2 border-top">
                            <div class="d-flex justify-content-between small mb-1">
                                <span>Affidabilità:</span>
                                <span class="fw-bold {% if affidabilita >= 90 %}text-success{% elif affidabilita >= 70 %}text-warning{% else %}text-danger{% endif %}">{{ affidabilita }}%</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar {% if affidabilita >= 90 %}bg-success{% elif affidabilita >= 70 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ affidabilita }}%"></div>
                            </div>
                        </div>
                        
                        <div class="mt-2 small d-flex justify-content-between text-muted" style="font-size: 0.7rem;">
                            <span title="Allenamenti Saltati" class="text-danger">{{ profilo.allenamenti_saltati }} Saltati</span>
                            <span title="Rinunce comunicate" class="text-secondary">{{ rinunce_count }} Rinunce</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indici Internazionali -->
            {% if profilo.indice_itra > 0 or profilo.indice_utmb > 0 %}
            <div class="row g-3 mb-4">
                {% if profilo.indice_itra > 0 %}
                <div class="col-md-6">
                    <div class="card p-3 text-center text-white shadow-sm" style="background-color: #2c3e50;">
                        <small class="d-block text-uppercase opacity-75 fw-bold">ITRA Index</small>
                        <span class="display-6 fw-bold">{{ profilo.indice_itra }}</span>
                        <div class="fw-bold text-uppercase mt-2" style="font-size: 0.9rem; letter-spacing: 1px; opacity: 0.9;">{{ livello_itra }}</div>
                    </div>
                </div>
                {% endif %}
                {% if profilo.indice_utmb > 0 %}
                <div class="col-md-6">
                    <div class="card p-3 text-center text-black shadow-sm" style="background-color: #ffc107;">
                        <small class="d-block text-uppercase opacity-75 fw-bold">UTMB Index</small>
                        <span class="display-6 fw-bold">{{ profilo.indice_utmb }}</span>
                        <div class="fw-bold text-uppercase mt-2" style="font-size: 0.9rem; letter-spacing: 1px; opacity: 0.8;">{{ livello_utmb }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Grafici Dashboard -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card p-3 h-100 shadow-sm">
                        <h6 class="fw-bold text-muted mb-3 small text-uppercase">Frequenza Cardiaca (bpm)</h6>
                        <canvas id="chartFC"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-3 h-100 shadow-sm">
                        <h6 class="fw-bold text-muted mb-3 small text-uppercase">Passo Medio (min/km)</h6>
                        <canvas id="chartPace"></canvas>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card p-3 shadow-sm">
                        <h6 class="fw-bold text-muted mb-3 small text-uppercase">Volume (Distanza & Dislivello)</h6>
                        <canvas id="chartDistElev" height="300"></canvas>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card p-3 shadow-sm">
                        <h6 class="fw-bold text-muted mb-3 small text-uppercase">Potenza Media (Watt)</h6>
                        <canvas id="chartPower" height="300"></canvas>
                    </div>
                </div>
            </div>

            <div class="card p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-calendar3 me-2"></i>Ultime Sessioni</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>KM</th>
                                <th>Passo</th>
                                <th>D+</th>
                                <th>VAM</th>
                                <th>Kcal</th>
                                <th>VO2 Abs</th>
                                <th>FC Media</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for act in attivita_recenti %}
                            <tr>
                                <td class="small">
                                    <a href="https://www.strava.com/activities/{{ act.strava_activity_id }}" target="_blank" class="text-decoration-none text-dark" title="Vedi su Strava">
                                        {{ act.data|date:"d/m/Y" }} <i class="bi bi-box-arrow-up-right text-primary" style="font-size: 0.65rem;"></i>
                                    </a>
                                </td>
                                <td>
                                    {% if act.tipo_attivita == "TrailRun" %}
                                        <i class="bi bi-mountain text-success me-1"></i> Trail
                                    {% else %}
                                        <i class="bi bi-signpost-split text-primary me-1"></i> Strada
                                    {% endif %}
                                </td>
                                <td class="fw-bold">{{ act.distanza_km }}</td>
                                <td>{{ act.passo_medio }}</td>
                                <td><span class="text-muted">+{{ act.dislivello|floatformat:0 }}m</span></td>
                                <td><span class="fw-bold text-warning">{{ act.vam }} m/h</span></td>
                                <td>{{ act.kcal_stimate|default:"--" }}</td>
                                <td><span class="text-primary fw-bold">{{ act.vo2max_assoluto|default:"--" }}</span> <small class="text-muted">L/min</small></td>
                                <td><span class="badge bg-light text-dark">{{ act.fc_media }} bpm</span></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-center py-4">Nessuna attività trovata. Sincronizza con Strava.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

<!-- Modal Allarmi Fisiologici -->
<div class="modal fade" id="alarmsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Attenzione: Segnalazioni Coach</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% for alert in allarmi %}
                <div class="alert alert-{{ alert.tipo }} mb-3 shadow-sm">
                    <h6 class="fw-bold"><i class="bi bi-activity me-2"></i>{{ alert.titolo }}</h6>
                    <p class="mb-0 small">{{ alert.msg }}</p>
                </div>
                {% endfor %}
                <div class="text-muted small mt-3 fst-italic">
                    <i class="bi bi-info-circle me-1"></i>Questi avvisi sono generati automaticamente analizzando il tuo carico di lavoro (ACWR) e i trend cardiaci recenti.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Ho capito</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novità -->
<div class="modal fade" id="newsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-stars me-2"></i>Novità: Allenamenti & Classifiche</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="bi bi-trophy display-1 text-warning"></i>
                </div>
                <h5 class="fw-bold text-center mb-3">Nuove Funzionalità!</h5>
                <p>Abbiamo introdotto gli <strong>Allenamenti di Gruppo</strong> e aggiornato il <strong>Riepilogo Atleti</strong>:</p>
                <ul class="list-group list-group-flush text-start small mb-3">
                    <li class="list-group-item"><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Allenamenti di Gruppo:</strong> Crea eventi, carica tracce GPX e invita i compagni.</li>
                    <li class="list-group-item"><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Podio Virtuale:</strong> Scopri i Top 3 della settimana basati su Km e Sforzo.</li>
                    <li class="list-group-item"><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Grafici Visuali:</strong> Barre di progresso per i Km e grafico "scalatori" per il dislivello.</li>
                    <li class="list-group-item"><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Colonne Settimanali:</strong> Nuove colonne "KM Week" e "D+ Week" nella tabella.</li>
                    <li class="list-group-item"><i class="bi bi-check-circle-fill text-success me-2"></i><strong>Ordinamento:</strong> Clicca sulle intestazioni per ordinare la classifica.</li>
                </ul>
                <div class="d-grid gap-2">
                    <a href="{% url 'lista_allenamenti' %}" class="btn btn-primary">Vai agli Allenamenti</a>
                    <a href="{% url 'riepilogo_atleti' %}" class="btn btn-outline-primary">Vai al Riepilogo</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Analisi AI Personale -->
<div class="modal fade" id="aiPersonalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-robot me-2"></i>Analisi Performance AI</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="aiPersonalLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted">Gemini sta analizzando le tue ultime 3 settimane...</p>
                </div>
                
                <!-- Contenitore per il PDF -->
                <div id="aiPersonalContent" class="d-none bg-white p-5">
                    <div class="text-center mb-5 border-bottom pb-4">
                        <h1 class="fw-bold text-primary mb-2"><i class="bi bi-graph-up-arrow me-2"></i>Performance Report</h1>
                        <p class="text-muted h5">Analisi Avanzata & Suggerimenti Coach AI</p>
                    </div>
                    
                    <div class="row mb-5">
                        <div class="col-6">
                            <h5 class="fw-bold text-uppercase text-secondary mb-3">Profilo Atleta</h5>
                            <ul class="list-unstyled">
                                <li class="mb-2"><strong>Nome:</strong> {{ profilo.user.first_name }} {{ profilo.user.last_name }}</li>
                                <li class="mb-2"><strong>Categoria:</strong> {{ livello_vo2max|default:"N/A" }}</li>
                                <li><strong>Data Report:</strong> <span id="reportDate"></span></li>
                            </ul>
                        </div>
                        <div class="col-6 text-end">
                            <div class="p-3 bg-light rounded d-inline-block text-start" style="min-width: 200px;">
                                <small class="d-block text-muted text-uppercase">VO2max Attuale</small>
                                <div class="display-6 fw-bold text-primary">{{ profilo.vo2max_stima_statistica|default:"--" }}</div>
                                <small class="text-success"><i class="bi bi-activity"></i> ml/kg/min</small>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 rounded-3" style="background-color: #f8f9fa; border-left: 5px solid #0d6efd;">
                        <h4 class="fw-bold mb-4"><i class="bi bi-robot me-2"></i>Analisi Tecnica</h4>
                        <div id="aiPersonalText" style="font-family: 'Segoe UI', sans-serif; line-height: 1.8; font-size: 1.05rem; color: #333;"></div>
                    </div>

                    <div class="mt-5 pt-4 border-top text-center text-muted small">
                        <p class="mb-1">Barilla Monitor System • Powered by Strava & Gemini AI</p>
                        <p>Generato il <span id="reportDateFooter"></span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <button type="button" class="btn btn-danger" onclick="scaricaPDFPersonale()"><i class="bi bi-file-earmark-pdf me-2"></i>Scarica PDF</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Anteprima Messaggi -->
<div class="modal fade" id="messagesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold"><i class="bi bi-envelope-paper me-2"></i>Altre Notifiche</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body bg-light">
                {% for n in notifiche_utente|slice:"3:" %}
                    <div class="card mb-2 shadow-sm border-0" id="modal-msg-{{ n.id }}">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between">
                                <h6 class="card-subtitle mb-2 text-muted small">{{ n.data_creazione|timesince }} fa</h6>
                                <button type="button" class="btn-close btn-sm" aria-label="Close" onclick="segnaLetta({{ n.id }}); document.getElementById('modal-msg-{{ n.id }}').remove();"></button>
                            </div>
                            <p class="card-text mb-2 fw-bold">{{ n.messaggio }}</p>
                            {% if n.link %}
                            <a href="{{ n.link }}" class="btn btn-sm btn-primary w-100" onclick="segnaLetta({{ n.id }})">
                                <i class="bi bi-eye me-1"></i>Vedi
                            </a>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Loading Sync -->
<div class="modal fade" id="syncModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="modal-body">
                <h4 class="fw-bold mb-3">Sincronizzazione in corso...</h4>
                <div class="progress mb-3" style="height: 25px;">
                    <div id="syncProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning text-dark fw-bold" role="progressbar" style="width: 0%">0%</div>
                </div>
                <p id="syncStatusText" class="text-muted mb-0">Inizializzazione connessione...</p>
                <p class="small text-warning mt-3 bg-light p-2 rounded"><i class="bi bi-info-circle-fill me-1"></i>Se è il primo download, l'operazione potrebbe richiedere alcuni minuti. Non chiudere la pagina.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    // Animazione CSS per il campanello (opzionale, inline per semplicità)
    const style = document.createElement('style');
    style.innerHTML = `@keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(15deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-15deg); } 100% { transform: rotate(0deg); } } .shake-animation { display: inline-block; animation: shake 2s infinite; }`;
    document.head.appendChild(style);

    // Inizializzazione Tooltip Bootstrap
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

    // Configurazione Grafici
    const labels = {{ chart_labels|safe }};
    const commonOptions = {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { x: { grid: { display: false } } }
    };

    // 1. FC Media
    new Chart(document.getElementById('chartFC'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{ data: {{ chart_fc|safe }}, borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.1)', tension: 0.3, fill: true }]
        },
        options: commonOptions
    });

    // 2. Passo Medio
    new Chart(document.getElementById('chartPace'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{ data: {{ chart_pace|safe }}, borderColor: '#0d6efd', backgroundColor: 'rgba(13, 110, 253, 0.1)', tension: 0.3, fill: true }]
        },
        options: commonOptions // Ripristinato: asse standard come richiesto
    });

    // 3. Distanza & Dislivello (Combinato)
    new Chart(document.getElementById('chartDistElev'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Distanza (km)',
                    data: {{ chart_dist|safe }},
                    backgroundColor: '#198754',
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 2
                },
                {
                    label: 'Dislivello (m)',
                    data: {{ chart_elev|safe }},
                    type: 'line',
                    borderColor: '#6c757d',
                    backgroundColor: 'rgba(108, 117, 125, 0.2)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    yAxisID: 'y1',
                    order: 1
                }
            ]
        },
        options: {
            ...commonOptions,
            plugins: { legend: { display: true } },
            scales: {
                x: { grid: { display: false } },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'km' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'm' }
                }
            }
        }
    });

    // 5. Potenza
    new Chart(document.getElementById('chartPower'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{ data: {{ chart_power|safe }}, borderColor: '#6610f2', backgroundColor: 'rgba(102, 16, 242, 0.1)', tension: 0.3, fill: true }]
        },
        options: commonOptions
    });

    let isReloading = false;

    // Funzione per avviare il sync e mostrare il modal
    function startSyncRedirect(event) {
        // Impediamo il reindirizzamento immediato del link
        event.preventDefault();
        
        const syncUrl = event.currentTarget.getAttribute('href');
        
        // Reset UI del Modal
        const progressBar = document.getElementById('syncProgressBar');
        const statusText = document.getElementById('syncStatusText');
        progressBar.style.width = '1%';
        progressBar.innerText = '';
        statusText.innerText = 'Contatto il server...';

        // Aggiungiamo timestamp per evitare che il browser usi la cache (es. redirect precedente)
        const uniqueUrl = syncUrl + (syncUrl.includes('?') ? '&' : '?') + '_t=' + new Date().getTime();

        // 1. Avvia la sincronizzazione in background
        fetch(uniqueUrl, { cache: "no-store", credentials: "include" })
            .then(response => {
                // Se il server ci ha reindirizzato al login (token scaduto), andiamo lì
                if (response.url && response.url.includes('login')) {
                    window.location.href = response.url;
                    return;
                }
                // Quando finisce, ricarica la pagina
                isReloading = true;
                window.location.reload();
            })
            .catch(error => {
                console.error("Errore sync:", error);
                // Mostriamo l'errore nel modal invece di ricaricare subito
                statusText.innerText = "Errore di connessione: " + error.message;
                statusText.classList.add('text-danger');
                progressBar.classList.remove('bg-warning');
                progressBar.classList.add('bg-danger');
            });

        // 2. Avvia il polling per aggiornare la barra (ogni 1s)
        const intervalId = setInterval(() => {
            fetch('/?sync_status=true', { credentials: "include" })
                .then(response => {
                    if (!response.ok) return null;
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    progressBar.style.width = data.progress + '%';
                    progressBar.innerText = data.progress + '%';
                    if (data.status) statusText.innerText = data.status;
                    if (data.progress >= 100) clearInterval(intervalId);
                });
        }, 1000);
    }

    window.addEventListener('beforeunload', function (e) {
        if (isReloading) return;

        // Mostra un avviso solo se il modal di sync è visibile
        var modal = document.getElementById('syncModal');
        if (modal && modal.classList.contains('show')) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Funzioni Analisi AI Personale
    function generaAnalisiPersonale() {
        const modal = new bootstrap.Modal(document.getElementById('aiPersonalModal'));
        modal.show();
        
        document.getElementById('aiPersonalLoading').classList.remove('d-none');
        document.getElementById('aiPersonalContent').classList.add('d-none');
        
        // Imposta la data odierna nel report
        const today = new Date().toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
        const reportDateEl = document.getElementById('reportDate');
        if(reportDateEl) reportDateEl.textContent = today;
        const reportDateFooterEl = document.getElementById('reportDateFooter');
        if(reportDateFooterEl) reportDateFooterEl.textContent = today;

        // Passiamo username per supportare la vista admin su altri atleti
        fetch("{% url 'analisi_gemini' %}?api=true&username={{ profilo.user.username }}")
            .then(response => response.json())
            .then(data => {
                document.getElementById('aiPersonalLoading').classList.add('d-none');
                const contentDiv = document.getElementById('aiPersonalContent');
                const textDiv = document.getElementById('aiPersonalText');
                contentDiv.classList.remove('d-none');
                
                // Formattazione Markdown base
                let formatted = data.analisi.replace(/\*\*(.*?)\*\*/g, '<strong class="text-primary">$1</strong>'); // Bold
                formatted = formatted.replace(/## (.*)/g, '<h5 class="fw-bold mt-4 mb-2 border-bottom pb-1">$1</h5>'); // Headers
                formatted = formatted.replace(/\n/g, '<br>');
                textDiv.innerHTML = formatted;
            })
            .catch(error => {
                document.getElementById('aiPersonalLoading').classList.add('d-none');
                document.getElementById('aiPersonalContent').classList.remove('d-none');
                document.getElementById('aiPersonalText').innerHTML = `<div class="alert alert-danger">Errore durante l'analisi: ${error}</div>`;
            });
    }

    function scaricaPDFPersonale() {
        const element = document.getElementById('aiPersonalContent');
        const opt = {
            margin: [10, 10],
            filename: 'Report_Performance_{{ profilo.user.username }}.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };
        html2pdf().set(opt).from(element).save();
    }

    // Funzione per segnare notifica come letta
    function segnaLetta(id) {
        fetch(`/notifica-letta/${id}/`, {method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}});
    }
</script>
{% endblock %}