{% extends 'base.html' %}

{% block content %}
<div class="container py-4" id="guida-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold"><i class="bi bi-book-half me-2"></i>Guida Utente & Metriche</h2>
        <div class="d-flex gap-2">
            <button onclick="downloadPDF()" class="btn btn-outline-danger"><i class="bi bi-file-pdf me-2"></i>Scarica PDF</button>
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">Torna alla Dashboard</a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Colonna Sinistra: Navigazione Rapida -->
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white fw-bold">
                    <i class="bi bi-lightning-charge me-2"></i>Come Iniziare
                </div>
                <div class="card-body">
                    <ol class="list-group list-group-numbered list-group-flush">
                        <li class="list-group-item">Collega il tuo account <strong>Strava</strong>.</li>
                        <li class="list-group-item">Vai su <strong>Impostazioni</strong> e inserisci il tuo <strong>Peso</strong> e la <strong>FC a Riposo</strong>. <span class="text-danger small">(Fondamentali per i calcoli!)</span></li>
                        <li class="list-group-item">Esegui la <strong>Sincronizzazione</strong> per scaricare le attivit√†.</li>
                        <li class="list-group-item">Controlla la Dashboard per vedere i tuoi progressi.</li>
                    </ol>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark fw-bold">
                    <i class="bi bi-info-circle me-2"></i>FAQ Rapide
                </div>
                <div class="card-body small">
                    <p class="fw-bold mb-1">Perch√© i dati non coincidono con Strava?</p>
                    <p class="text-muted mb-3">Usiamo algoritmi diversi. Strava spesso sovrastima le calorie e usa formule generiche per il fitness. Noi usiamo formule specifiche per l'atletica leggera e il trail running.</p>
                    
                    <p class="fw-bold mb-1">Ogni quanto si aggiornano i dati?</p>
                    <p class="text-muted mb-3">La sincronizzazione automatica avviene ogni notte. Puoi forzarla manualmente dal pulsante "Sincronizza Strava" nella dashboard.</p>

                    <p class="fw-bold mb-1">Cos'√® il "Peso Manuale"?</p>
                    <p class="text-muted mb-0">Se attivato nelle impostazioni, il sistema ignorer√† il peso fornito da Strava e user√† quello inserito da te per calcolare Watt e VO2max.</p>
                </div>
            </div>
        </div>

        <!-- Colonna Destra: Spiegazione Metriche -->
        <div class="col-md-8">
            <!-- VO2max -->
            <div class="card shadow-sm mb-4 border-start border-4 border-danger">
                <div class="card-body">
                    <h4 class="fw-bold text-danger"><i class="bi bi-lungs me-2"></i>VO2max Stimato</h4>
                    <p>Il massimo volume di ossigeno che il tuo corpo pu√≤ consumare. √à l'indicatore principale della tua "cilindrata" aerobica.</p>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="fw-bold">üìä Stima Statistica (Il dato principale)</h6>
                            <p class="small text-muted">√à una media mobile delle ultime 60 attivit√†. Include sia <strong>Strada</strong> che <strong>Trail</strong>. Per il Trail, il sistema converte il dislivello in distanza piana (100m D+ ‚âà 500m piani) per valutare lo sforzo reale.</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">üõ£Ô∏è Solo Strada</h6>
                            <p class="small text-muted">Considera solo le corse su asfalto (tipo "Run"). Usa la formula scientifica ACSM pura. √à il dato pi√π affidabile per confrontare la tua velocit√† pura.</p>
                        </div>
                    </div>
                    <div class="alert alert-light border mt-2 small">
                        <strong>Formula utilizzata:</strong> Mix ponderato tra la <em>Prestazione Reale</em> (Metodo Karvonen basato sulla riserva cardiaca) e il <em>Potenziale Fisiologico</em> (Rapporto FC Max / FC Riposo).
                    </div>
                </div>
            </div>

            <!-- VAM -->
            <div class="card shadow-sm mb-4 border-start border-4 border-warning">
                <div class="card-body">
                    <h4 class="fw-bold text-warning"><i class="bi bi-graph-up-arrow me-2"></i>VAM Selettiva (m/h)</h4>
                    <p>La Velocit√† Ascensionale Media indica quanti metri di dislivello riesci a salire in un'ora.</p>
                    
                    <div class="d-flex align-items-start mt-3">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-3 fs-4"></i>
                        <div>
                            <h6 class="fw-bold">Perch√© "Selettiva"?</h6>
                            <p class="small text-muted mb-0">
                                A differenza dei calcoli standard (Dislivello Totale / Tempo Totale), il nostro algoritmo analizza la traccia GPS secondo per secondo e calcola la velocit√† <strong>SOLO nei tratti con pendenza > 7%</strong>.
                                <br>Questo esclude i falsi piani, le discese e le pause, fornendo la tua vera capacit√† di scalatore.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Potenza -->
            <div class="card shadow-sm mb-4 border-start border-4 border-primary" style="border-color: #6610f2 !important;">
                <div class="card-body">
                    <h4 class="fw-bold" style="color: #6610f2;"><i class="bi bi-lightning-fill me-2"></i>Potenza (Watt)</h4>
                    <p>Una stima dell'energia meccanica prodotta durante la corsa. Utile per gestire lo sforzo indipendentemente dal terreno.</p>
                    <p class="small text-muted">
                        Calcolata usando l'equazione di <strong>Minetti</strong> che considera:
                        <br><code>Peso Atleta √ó Velocit√† √ó Costo Energetico della Pendenza</code>.
                        <br>Il valore √® normalizzato per essere simile a quello dei sensori Stryd (Efficienza ~25%).
                    </p>
                </div>
            </div>

            <!-- Soglie -->
            <div class="card shadow-sm mb-4 border-start border-4 border-success">
                <div class="card-body">
                    <h4 class="fw-bold text-success"><i class="bi bi-heart-pulse me-2"></i>Soglie Cardiache</h4>
                    <p>Stimate automaticamente in base alla tua FC Max e FC Riposo (Formula Karvonen).</p>
                    <ul class="list-unstyled small text-muted mt-2">
                        <li class="mb-2">
                            <span class="badge bg-success me-2">Soglia Aerobica (Z2)</span>
                            <strong>~72% della Riserva Cardiaca.</strong> Il limite superiore del "Fondo Lento". Puoi parlare mentre corri. Ottimo per bruciare grassi e costruire resistenza base.
                        </li>
                        <li>
                            <span class="badge bg-danger me-2">Soglia Anaerobica (Z4)</span>
                            <strong>~90% della Riserva Cardiaca.</strong> Il ritmo gara sui 10km/Mezza Maratona. Oltre questo limite si accumula acido lattico rapidamente.
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Trend -->
            <div class="card shadow-sm border-start border-4 border-secondary">
                <div class="card-body">
                    <h4 class="fw-bold text-secondary"><i class="bi bi-trends me-2"></i>Trend e Frecce</h4>
                    <p>Nella dashboard vedrai delle percentuali colorate (es. <span class="text-success fw-bold">+2.5%</span>).</p>
                    <p class="small text-muted mb-0">
                        Indicano come sta cambiando la tua forma fisica. Il sistema confronta la media delle tue <strong>ultime 5 attivit√†</strong> con la media delle <strong>precedenti 15</strong>.
                        <br>
                        <span class="text-success">Verde</span>: Stai migliorando (o riposando, nel caso della FC).
                        <br>
                        <span class="text-danger">Rosso</span>: Prestazione in calo o fatica accumulata (FC pi√π alta a parit√† di passo).
                    </p>
                </div>
            </div>

        </div>
    </div>

    {% if request.user.is_staff %}
    <hr class="my-5 border-danger border-3 opacity-100">
    
    <div class="row">
        <div class="col-12">
            <div class="card shadow border-danger">
                <div class="card-header bg-danger text-white fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-shield-lock-fill me-2"></i>Sezione Admin & Coach</span>
                    <span class="badge bg-white text-danger">Staff Only</span>
                </div>
                <div class="card-body">
                    <h4 class="fw-bold mb-3">Dashboard Coach: Guida alla Lettura</h4>
                    <p>La Dashboard Coach aggrega i dati di tutti gli atleti per fornire una visione d'insieme dello stato di forma della squadra.</p>

                    <div class="row g-4 mt-2">
                        <!-- 1. ACWR -->
                        <div class="col-md-6">
                            <h6 class="fw-bold text-danger">1. ACWR (Acute:Chronic Workload Ratio)</h6>
                            <p class="small text-muted mb-2">
                                Indicatore per prevenzione infortuni. Confronta il carico acuto (7gg) con quello cronico (28gg).
                                <br><strong>Formula:</strong> <code>Km + (Dislivello / 100)</code>.
                            </p>
                            <ul class="small list-unstyled">
                                <li><span class="badge bg-success me-2">0.8 - 1.3</span> <strong>Sweet Spot:</strong> Ottimale.</li>
                                <li><span class="badge bg-warning text-dark me-2">> 1.3</span> <strong>High Risk:</strong> Rischio infortunio.</li>
                                <li><span class="badge bg-secondary me-2">< 0.8</span> <strong>Detraining:</strong> Perdita forma.</li>
                            </ul>
                        </div>

                        <!-- 2. Allarmi Fisiologici -->
                        <div class="col-md-6">
                            <h6 class="fw-bold text-warning">2. Allarmi Fisiologici (FC in aumento)</h6>
                            <p class="small text-muted">
                                Il sistema monitora la Frequenza Cardiaca media a parit√† di passo.
                                <br>Se un atleta mostra un <strong>aumento > 5%</strong> della FC media nelle ultime 5 attivit√† rispetto al suo storico, viene segnalato un possibile stato di affaticamento o malattia.
                            </p>
                        </div>

                        <!-- 3. Volume & Inattivi -->
                        <div class="col-md-6">
                            <h6 class="fw-bold text-success">3. Volume & Partecipazione</h6>
                            <ul class="small list-unstyled">
                                <li class="mb-1"><strong>Volume Settimanale:</strong> Somma dei km totali della squadra. La freccia indica il trend rispetto alla settimana precedente.</li>
                                <li><strong>Atleti Inattivi (>7gg):</strong> Lista degli atleti che non hanno caricato attivit√† su Strava negli ultimi 7 giorni. Utile per identificare chi ha mollato o √® infortunato.</li>
                            </ul>
                        </div>

                        <!-- 4. Distribuzione & Tipologia -->
                        <div class="col-md-6">
                            <h6 class="fw-bold" style="color: #0d6efd;">4. Distribuzione Livelli & Tipologia</h6>
                            <ul class="small list-unstyled">
                                <li class="mb-1"><strong>Livello (Stima):</strong> Suddivisione squadra basata sul VO2max medio (Trail + Strada).</li>
                                <li class="mb-1"><strong>Livello (Strada):</strong> Focus specifico sulle prestazioni su asfalto.</li>
                                <li><strong>Tipologia (90gg):</strong> Percentuale di attivit√† Trail vs Strada negli ultimi 3 mesi.</li>
                            </ul>
                        </div>

                        <!-- 5. Trend Performance -->
                        <div class="col-md-6">
                            <h6 class="fw-bold" style="color: #6f42c1;">5. Trend Performance</h6>
                            <ul class="small list-unstyled">
                                <li class="mb-1"><strong>Top Improvers:</strong> Atleti con il maggior incremento percentuale di VO2max (Ultime 5 vs Storico).</li>
                                <li><strong>Trend in Calo:</strong> Atleti che stanno peggiorando le prestazioni (VO2max in discesa).</li>
                            </ul>
                        </div>

                        <!-- 6. Race Readiness -->
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary">6. Race Readiness (Prontezza Gara)</h6>
                            <p class="small text-muted mb-1">
                                Classificazione automatica basata su Volume Settimanale e Lungo Max (ultimi 45gg).
                            </p>
                            <div class="small text-muted">
                                Es: <strong>Ultra Marathon</strong> (>60km/sett, Lungo >28km).
                            </div>
                        </div>

                        <!-- 7. Classifiche Top -->
                        <div class="col-md-6">
                            <h6 class="fw-bold text-dark">7. Classifiche Top</h6>
                            <ul class="small list-unstyled">
                                <li><strong>Top ITRA/UTMB:</strong> I migliori punteggi ufficiali scaricati.</li>
                                <li><strong>Top Potenza (W):</strong> I valori pi√π alti di Potenza Media (Watt) sulle ultime 30 attivit√†.</li>
                            </ul>
                        </div>

                        <!-- 8. AI -->
                        <div class="col-md-6">
                            <h6 class="fw-bold text-info">8. Analisi AI (Gemini)</h6>
                            <p class="small text-muted mb-0">
                                Cliccando su "Analisi Coach AI", l'intelligenza artificiale analizza tutti questi dati aggregati per fornire un report narrativo sullo stato della squadra e suggerimenti per il microciclo successivo.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    function downloadPDF() {
        const element = document.getElementById('guida-content');
        const opt = {
            margin: [0.3, 0.3],
            filename: 'Guida_Barilla_Monitor.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, letterRendering: true },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        
        // Nascondi i pulsanti prima di stampare per un PDF pulito
        const buttons = element.querySelectorAll('button, a.btn');
        buttons.forEach(b => b.style.display = 'none');

        html2pdf().set(opt).from(element).save().then(() => {
            // Ripristina i pulsanti dopo il download
            buttons.forEach(b => b.style.display = '');
        });
    }
</script>
{% endblock %}