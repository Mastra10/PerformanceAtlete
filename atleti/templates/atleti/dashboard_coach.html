{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header & Navigation -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">Coach Dashboard üß¢</h2>
            <p class="text-muted mb-0">Panoramica squadra e stato di forma</p>
        </div>
        <div class="btn-group">
            <a href="?week={{ prev_offset }}" class="btn btn-outline-secondary"><i class="bi bi-chevron-left"></i> Settimana Precedente</a>
            <button type="button" class="btn btn-secondary disabled">{{ week_label }}</button>
            <a href="?week={{ next_offset }}" class="btn btn-outline-secondary {% if week_offset >= 0 %}disabled{% endif %}">Settimana Successiva <i class="bi bi-chevron-right"></i></a>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card p-3 border-0 shadow-sm h-100">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted text-uppercase small">Volume Squadra</h6>
                        <h3 class="fw-bold mb-0">{{ vol_current_km }} km</h3>
                    </div>
                    <div class="text-end">
                        <span class="badge {% if trend_vol >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                            {% if trend_vol >= 0 %}+{% endif %}{{ trend_vol }}%
                        </span>
                        <small class="d-block text-muted mt-1">vs {{ vol_prev_km }} km</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 border-0 shadow-sm h-100">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted text-uppercase small">Atleti Attivi</h6>
                        <h3 class="fw-bold mb-0">{{ total_athletes }}</h3>
                    </div>
                    <div class="text-end">
                        <i class="bi bi-people-fill h3 text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 border-0 shadow-sm h-100">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted text-uppercase small">Tasso Inattivit√†</h6>
                        <h3 class="fw-bold mb-0">{{ perc_inattivi }}%</h3>
                    </div>
                    <div class="text-end">
                        <span class="badge {% if perc_inattivi < 20 %}bg-success{% else %}bg-warning{% endif %}">
                            {{ atleti_inattivi|length }} atleti
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 border-0 shadow-sm h-100 bg-light">
                <button onclick="generaAnalisiCoach()" class="btn btn-primary w-100 h-100 d-flex align-items-center justify-content-center">
                    <i class="bi bi-stars me-2"></i> Genera Report AI
                </button>
            </div>
        </div>
    </div>

    <!-- AI Report Area -->
    <div id="aiReportArea" class="alert alert-info d-none">
        <h5 class="alert-heading"><i class="bi bi-robot me-2"></i>Analisi Coach AI</h5>
        <div id="aiReportContent" style="white-space: pre-line;"></div>
    </div>

    <div class="row g-4">
        <!-- Colonna Sinistra: Allarmi e Liste -->
        <div class="col-lg-8">
            
            <!-- ACWR Alerts (NEW) -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold m-0 text-danger"><i class="bi bi-activity me-2"></i>Allarmi Carico (ACWR)</h5>
                </div>
                <div class="card-body">
                    {% if acwr_alerts %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Atleta</th>
                                    <th>Status</th>
                                    <th>Ratio</th>
                                    <th>Carico Acuto (7gg)</th>
                                    <th>Carico Cronico (28gg)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in acwr_alerts %}
                                <tr>
                                    <td class="fw-bold">
                                        <a href="{% url 'dashboard_atleta' alert.atleta.user.username %}" class="text-decoration-none text-dark">
                                            {{ alert.atleta.user.first_name }} {{ alert.atleta.user.last_name }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if 'Risk' in alert.status %}
                                            <span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>High Risk</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark"><i class="bi bi-graph-down me-1"></i>Detraining</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-bold {% if 'Risk' in alert.status %}text-danger{% else %}text-warning{% endif %}">{{ alert.ratio }}</td>
                                    <td>{{ alert.acute }} <small class="text-muted">km-sforzo</small></td>
                                    <td>{{ alert.chronic }} <small class="text-muted">km-sforzo</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-success">
                        <i class="bi bi-check-circle-fill h3 d-block mb-2"></i>
                        <p class="mb-0">Nessun allarme di carico rilevato. La squadra si allena in modo bilanciato (0.8 - 1.3).</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- FC Alerts -->
            {% if fc_alerts %}
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold m-0 text-warning"><i class="bi bi-heart-pulse me-2"></i>Allarmi Frequenza Cardiaca</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead><tr><th>Atleta</th><th>Aumento FC Media</th><th>Dettagli</th></tr></thead>
                            <tbody>
                                {% for item in fc_alerts %}
                                <tr>
                                    <td>{{ item.atleta.user.first_name }} {{ item.atleta.user.last_name }}</td>
                                    <td class="text-danger fw-bold">+{{ item.trends.fc_media }}%</td>
                                    <td class="small text-muted">Possibile affaticamento o disidratazione</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Performance Lists -->
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h6 class="m-0"><i class="bi bi-graph-up-arrow me-2"></i>Top Improvers (VO2max)</h6>
                        </div>
                        <ul class="list-group list-group-flush">
                            {% for item in top_improvers %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ item.atleta.user.first_name }} {{ item.atleta.user.last_name }}
                                <span class="badge bg-success rounded-pill">+{{ item.trends.vo2max }}%</span>
                            </li>
                            {% empty %}
                            <li class="list-group-item text-muted text-center">Nessun miglioramento significativo</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="m-0"><i class="bi bi-graph-down-arrow me-2"></i>In Calo / Struggling</h6>
                        </div>
                        <ul class="list-group list-group-flush">
                            {% for item in struggling %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ item.atleta.user.first_name }} {{ item.atleta.user.last_name }}
                                <span class="badge bg-secondary rounded-pill">{{ item.trends.vo2max }}%</span>
                            </li>
                            {% empty %}
                            <li class="list-group-item text-muted text-center">Nessun calo significativo</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Inattivi -->
            {% if atleti_inattivi %}
            <div class="card mt-4 border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="m-0 text-muted">Atleti Inattivi (> 7 giorni)</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        {% for a in atleti_inattivi %}
                        <span class="badge bg-light text-dark border">
                            {{ a.user.first_name }} {{ a.user.last_name }}
                            <span class="text-muted ms-1">({{ a.last_act|date:"d/m"|default:"Mai" }})</span>
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- Colonna Destra: Grafici e Classifiche -->
        <div class="col-lg-4">
            <!-- Charts -->
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="fw-bold text-center mb-3">Distribuzione VO2max (Stimato)</h6>
                    <canvas id="vo2PieChart" height="200"></canvas>
                </div>
            </div>

            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="fw-bold text-center mb-3">Trail vs Strada (90gg)</h6>
                    <canvas id="trailRoadChart" height="150"></canvas>
                </div>
            </div>

            <!-- Rankings -->
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-header bg-white fw-bold">üèÜ Top ITRA Index</div>
                <ul class="list-group list-group-flush small">
                    {% for a in top_itra %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ forloop.counter }}. {{ a.user.first_name }} {{ a.user.last_name }}</span>
                        <span class="fw-bold">{{ a.indice_itra }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-header bg-white fw-bold">‚ö° Top Power (W)</div>
                <ul class="list-group list-group-flush small">
                    {% for item in top_power %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ forloop.counter }}. {{ item.atleta.user.first_name }} {{ item.atleta.user.last_name }}</span>
                        <span class="fw-bold">{{ item.power }} W</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            
            <!-- Race Readiness -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white fw-bold">üèÅ Race Readiness</div>
                <div class="card-body p-2">
                    {% for cat, data in readiness.items %}
                    {% if data.percentage > 0 %}
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small mb-1">
                            <span>{{ cat }}</span>
                            <span>{{ data.percentage }}%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ data.percentage }}%"></div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // VO2max Pie Chart
    const ctxVo2 = document.getElementById('vo2PieChart').getContext('2d');
    new Chart(ctxVo2, {
        type: 'doughnut',
        data: {
            labels: {{ vo2_labels|safe }},
            datasets: [{
                data: {{ vo2_data|safe }},
                backgroundColor: ['#ffc107', '#0dcaf0', '#0d6efd', '#198754', '#6c757d'],
                borderWidth: 0
            }]
        },
        options: {
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } }
        }
    });

    // Trail vs Road Bar Chart
    const ctxTR = document.getElementById('trailRoadChart').getContext('2d');
    new Chart(ctxTR, {
        type: 'bar',
        data: {
            labels: ['Strada', 'Trail'],
            datasets: [{
                label: 'Attivit√†',
                data: {{ trail_road_data|safe }},
                backgroundColor: ['#6c757d', '#198754'],
                borderRadius: 4
            }]
        },
        options: {
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: { x: { display: false }, y: { grid: { display: false } } }
        }
    });

    // Funzione per chiamare l'analisi AI
    function generaAnalisiCoach() {
        const btn = document.querySelector('button[onclick="generaAnalisiCoach()"]');
        const area = document.getElementById('aiReportArea');
        const content = document.getElementById('aiReportContent');
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analisi in corso...';
        
        // Recupera week offset dall'URL
        const urlParams = new URLSearchParams(window.location.search);
        const week = urlParams.get('week') || 0;

        fetch(`/coach/analisi/?week=${week}`)
            .then(response => response.json())
            .then(data => {
                area.classList.remove('d-none');
                // Formattazione base del markdown
                let html = data.analisi
                    .replace(/## (.*)/g, '<h5>$1</h5>')
                    .replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>')
                    .replace(/- /g, '‚Ä¢ ');
                content.innerHTML = html;
                btn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Fatto';
            })
            .catch(err => {
                alert("Errore durante l'analisi: " + err);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-stars me-2"></i> Riprova';
            });
    }
</script>
{% endblock %}
